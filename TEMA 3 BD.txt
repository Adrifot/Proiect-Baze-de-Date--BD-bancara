-- 1
WITH FORMATII AS (
    SELECT DISTINCT F.ID_FORMATIE, F.NUME, F.WEBSITE
    FROM FORMATIE F
    JOIN CASTIGA C ON F.ID_FORMATIE = C.ID_FORMATIE
    JOIN PREMIU P ON C.ID_PREMIU = P.ID_PREMIU
    WHERE P.FRECVENTA = 'Anual'
) SELECT FORM.NUME, FORM.WEBSITE, A.NUME, A.PRET
FROM FORMATII FORM 
JOIN ALBUM A ON FORM.ID_FORMATIE = A.ID_FORMATIE
WHERE A.PRET > 30;
 
--2 (varianta A)
WITH TABEL AS (
    SELECT F.NUME, P.CONCURS, P.SECTIUNE, C.LOC_OCUPAT, MAX(A.DATA_L) AS "ULT"
    FROM PREMIU P
    JOIN CASTIGA C ON P.ID_PREMIU = C.ID_PREMIU
    JOIN FORMATIE F ON C.ID_FORMATIE = F.ID_FORMATIE
    JOIN ALBUM A ON A.ID_FORMATIE = F.ID_FORMATIE
    GROUP BY F.NUME, P.CONCURS, P.SECTIUNE, C.LOC_OCUPAT
) SELECT T.NUME, T.CONCURS, T.SECTIUNE, T.LOC_OCUPAT, ALB.NUME
FROM TABEL T
JOIN ALBUM ALB ON T.ULT = ALB.DATA_L;

--2 (varianta B)
SELECT F.NUME, P.CONCURS, P.SECTIUNE, C.LOC_OCUPAT, A.NUME
FROM CASTIGA C
JOIN PREMIU P ON C.ID_PREMIU = P.ID_PREMIU
JOIN ALBUM A ON A.ID_FORMATIE = C.ID_FORMATIE
    AND A.DATA_L = (
        SELECT MAX(A2.DATA_L)
        FROM ALBUM A2
        WHERE A2.ID_FORMATIE = C.ID_FORMATIE
    )
JOIN FORMATIE F ON F.ID_FORMATIE = C.ID_FORMATIE;

-- Ambele variante par sa dea acelasi rezultat, care este varianta mai corecta?


-- 3
SELECT F.NUME, F.DATA_LANSARE, COUNT(A.ID_ALBUM)
FROM FORMATIE F
JOIN ALBUM A ON A.ID_FORMATIE = F.ID_FORMATIE
JOIN CASTIGA C ON F.ID_FORMATIE = C.ID_FORMATIE
JOIN PREMIU P ON P.ID_PREMIU = C.ID_PREMIU
WHERE P.FRECVENTA = 'Bianual'
GROUP BY F.NUME, F.DATA_LANSARE
MINUS
SELECT F.NUME, F.DATA_LANSARE, COUNT(A.ID_ALBUM)
FROM FORMATIE F
JOIN ALBUM A ON A.ID_FORMATIE = F.ID_FORMATIE
JOIN CASTIGA C ON F.ID_FORMATIE = C.ID_FORMATIE
JOIN PREMIU P ON P.ID_PREMIU = C.ID_PREMIU
WHERE P.FRECVENTA <> 'Bianual'
GROUP BY F.NUME, F.DATA_LANSARE;

--4
CREATE OR REPLACE VIEW VIZ_1 AS (
    SELECT F1.ID_FORMATIE, F1.NUME, F1.DATA_LANSARE, F1.DATA_RETRAGERE, F1.WEBSITE, F1.TARA_PROV
    FROM FORMATIE F1
    WHERE F1.ID_FORMATIE  IN (
        SELECT F.ID_FORMATIE
        FROM FORMATIE F
        JOIN ALBUM A ON A.ID_FORMATIE = F.ID_FORMATIE
        WHERE A.GEN = 'Pop' AND F.ID_FORMATIE NOT IN (
            SELECT C.ID_FORMATIE
            FROM CASTIGA C
        )
    )
);

SELECT * FROM FORMATIE;

INSERT INTO VIZ_1 (ID_FORMATIE, NUME, DATA_LANSARE, DATA_RETRAGERE, WEBSITE, TARA_PROV)
VALUES (11, 'SadSvit', TO_DATE('04-APR-2020', 'DD-MON-YYYY'), NULL, 'www.sadsvit.ua', 'Ucraina');


-- exercitiul gresit din TEMA 2, refacut
WITH TABEL AS (
    SELECT S.ID_SECTIE, S.NUME AS NUME_SECTIE, CASE WHEN MAX(D.SALARIU) IS NULL THEN 0 ELSE MAX(D.SALARIU) END AS SALARIU
    FROM SECTIE S
    LEFT JOIN DOCTOR D ON D.ID_SECTIE = S.ID_SECTIE
    GROUP BY S.ID_SECTIE, S.NUME
) SELECT CASE WHEN D.NUME IS NULL THEN '-' ELSE D.NUME END AS NUME, CASE WHEN D.PRENUME IS NULL THEN '-' ELSE D.PRENUME END AS PRENUME, T.NUME_SECTIE, T.SALARIU
FROM DOCTOR D
RIGHT JOIN TABEL T ON T.ID_SECTIE = D.ID_SECTIE AND D.SALARIU = T.SALARIU


